<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>ğŸ“¦ KHO NHANH</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body{font-family:-apple-system,Arial;background:#f2f2f2;padding:10px}
h2,h3{text-align:center}
input,button{width:100%;font-size:20px;padding:12px;margin:6px 0}
button{border:none;border-radius:8px;color:#fff}
.n{background:#28a745}.x{background:#dc3545}
.ex{background:#17a2b8}.del{background:#6c757d}
.print{background:#343a40}
.edit{background:#ffc107;color:#000}
table{width:100%;background:#fff;border-collapse:collapse;margin-top:10px}
td,th{border:1px solid #ccc;padding:6px;font-size:16px;text-align:center}
.low{background:#ffd6d6}
.thumb{width:70px;height:70px;object-fit:cover;border-radius:8px}

/* ===== PRINT ===== */
#printArea{display:none}
@media print{
 body *{display:none}
 #printArea{
  display:block;
  position:fixed;
  inset:0;
  background:#fff;
 }
 #printArea *{display:block}
}
</style>
</head>
<body>

<h2>ğŸ“¦ KHO NHANH</h2>

<input id="t" placeholder="TÃªn hÃ ng">
<input id="s" type="number" placeholder="Sá»‘ lÆ°á»£ng">
<input id="dv" placeholder="ÄÆ¡n vá»‹">
<input id="kh" placeholder="KhÃ¡ch hÃ ng">

<button class="n" onclick="nhap()">â• NHáº¬P</button>
<button class="x" onclick="xuat()">â– XUáº¤T</button>
<button class="print" onclick="inPDF()">ğŸ–¨ï¸ IN PHIáº¾U</button>
<button class="del" onclick="xoa()">ğŸ—‘ï¸ XOÃ HÃ€NG</button>
<button class="ex" onclick="xuatExcel()">â¬‡ï¸ EXCEL</button>

<table>
<tr><th>HÃ ng</th><th>Tá»“n</th><th>ÄV</th><th>áº¢nh</th><th>áº¢nh</th></tr>
<tbody id="b"></tbody>
</table>

<input type="file" id="imgInput" accept="image/*" hidden>

<h3>ğŸ•’ Lá»ŠCH Sá»¬</h3>
<table>
<tr><th>Thá»i gian</th><th>HÃ ng</th><th>KH</th><th>Loáº¡i</th><th>SL</th></tr>
<tbody id="ls"></tbody>
</table>

<!-- ===== PRINT AREA ===== -->
<div id="printArea">
 <h3>PHIáº¾U XUáº¤T KHO</h3>
 <p>Thá»i gian: <span id="pTime"></span></p>
 <p>KhÃ¡ch hÃ ng: <span id="pKH"></span></p>
 <table>
  <tr><th>HÃ ng</th><th>SL</th><th>ÄV</th></tr>
  <tbody id="pBody"></tbody>
 </table>
 <br>
 <p>NgÆ°á»i giao _____________  NgÆ°á»i nháº­n _____________</p>
</div>

<script>
let k=JSON.parse(localStorage.getItem("k")||"{}");
let h=JSON.parse(localStorage.getItem("h")||"[]");
let hangDangSuaAnh="";

/* ===== NHáº¬P ===== */
function nhap(){
 if(!t.value||s.value<=0)return alert("Thiáº¿u dá»¯ liá»‡u");
 if(!k[t.value])k[t.value]={sl:0,dv:dv.value,img:""};
 k[t.value].sl+=+s.value;
 k[t.value].dv=dv.value;
 h.unshift({time:new Date().toISOString(),ten:t.value,kh:kh.value,loai:"Nháº­p",sl:+s.value});
 t.value=s.value=dv.value=kh.value="";
 save();
}

/* ===== XUáº¤T ===== */
function xuat(){
 if(!kh.value)return alert("ChÆ°a nháº­p khÃ¡ch hÃ ng");
 if(!k[t.value]||k[t.value].sl<+s.value)return alert("KhÃ´ng Ä‘á»§ tá»“n");
 k[t.value].sl-=+s.value;
 h.unshift({time:new Date().toISOString(),ten:t.value,kh:kh.value,loai:"Xuáº¥t",sl:+s.value});
 save();
}

/* ===== XOÃ ===== */
function xoa(){
 if(!t.value||!k[t.value])return alert("KhÃ´ng tÃ¬m tháº¥y");
 if(k[t.value].sl>0)return alert("CÃ²n tá»“n, khÃ´ng thá»ƒ xoÃ¡");
 if(confirm("XoÃ¡ hÃ ng nÃ y?")){delete k[t.value];save();}
}

/* ===== áº¢NH â€“ RÃ• IPHONE ===== */
function suaAnh(ten){
 hangDangSuaAnh=ten;
 imgInput.value="";
 imgInput.click();
}
imgInput.onchange=e=>{
 let f=e.target.files[0]; if(!f)return;
 let q=f.size>1024*1024?0.65:0.85;
 let r=new FileReader();
 r.onload=ev=>{
  let img=new Image();
  img.onload=()=>{
   let dpr=window.devicePixelRatio||2;
   let size=70, real=size*dpr;
   let s=Math.min(img.width,img.height);
   let c=document.createElement("canvas");
   c.width=c.height=real;
   let ctx=c.getContext("2d");
   ctx.setTransform(1,0,0,1,0,0);
   ctx.scale(dpr,dpr);
   ctx.imageSmoothingQuality="high";
   ctx.drawImage(img,(img.width-s)/2,(img.height-s)/2,s,s,0,0,size,size);
   k[hangDangSuaAnh].img=c.toDataURL("image/jpeg",q);
   save();
  };
  img.src=ev.target.result;
 };
 r.readAsDataURL(f);
};

/* ===== IN PDF (NHIá»€U DÃ’NG) ===== */
function inPDF(){
 let ds=h.filter(i=>i.loai=="Xuáº¥t");
 if(!ds.length)return alert("ChÆ°a cÃ³ xuáº¥t kho");

 let lastTime=ds[0].time;
 let same=ds.filter(i=>i.time===lastTime);

 pTime.textContent=new Date(lastTime).toLocaleString("vi-VN");
 pKH.textContent=same[0].kh;
 pBody.innerHTML=same.map(i=>
  `<tr><td>${i.ten}</td><td>${i.sl}</td><td>${k[i.ten].dv}</td></tr>`
 ).join("");

 window.print();
}

/* ===== EXCEL ===== */
function xuatExcel(){
 const wb=XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb,
  XLSX.utils.aoa_to_sheet([
   ["HÃ ng","Tá»“n","ÄV"],
   ...Object.keys(k).map(i=>[i,k[i].sl,k[i].dv])
  ]),"TonKho");
 XLSX.utils.book_append_sheet(wb,
  XLSX.utils.aoa_to_sheet([
   ["Thá»i gian","HÃ ng","KH","Loáº¡i","SL"],
   ...h.map(i=>[
    new Date(i.time).toLocaleString("vi-VN",{hour12:false}),
    i.ten,i.kh,i.loai,i.sl
   ])
  ]),"LichSu");
 XLSX.writeFile(wb,"kho_nhanh.xlsx");
}

/* ===== SAVE / RENDER ===== */
function save(){
 localStorage.setItem("k",JSON.stringify(k));
 localStorage.setItem("h",JSON.stringify(h));
 render();
}
function render(){
 b.innerHTML="";
 Object.keys(k).forEach(i=>{
  b.innerHTML+=`<tr class="${k[i].sl<=5?'low':''}">
   <td>${i}</td><td>${k[i].sl}</td><td>${k[i].dv}</td>
   <td>${k[i].img?`<img src="${k[i].img}" class="thumb">`:""}</td>
   <td><button class="edit" onclick="suaAnh('${i}')">ğŸ–¼</button></td>
  </tr>`;
 });
 ls.innerHTML=h.map(i=>`
 <tr>
  <td>${new Date(i.time).toLocaleString("vi-VN",{hour12:false})}</td>
  <td>${i.ten}</td><td>${i.kh||""}</td><td>${i.loai}</td><td>${i.sl}</td>
 </tr>`).join("");
}
render();
</script>
</body>
</html>
