<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>üì¶ KHO NHANH</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body{font-family:-apple-system,Arial;background:#f2f2f2;padding:10px}
h2,h3{text-align:center}
input,button,select{width:100%;font-size:20px;padding:12px;margin:6px 0}
button{border:none;border-radius:8px;color:#fff}
.n{background:#28a745}.x{background:#dc3545}
.ex{background:#17a2b8}.del{background:#6c757d}
.warn{background:#ff9800}
.print{background:#343a40}
.edit{background:#ffc107;color:#000}
table{width:100%;background:#fff;border-collapse:collapse;margin-top:10px}
td,th{border:1px solid #ccc;padding:6px;font-size:16px;text-align:center}
.low{background:#ffd6d6}
.thumb{width:70px;height:70px;object-fit:cover;border-radius:8px}
.suggestBox{background:#fff;border:1px solid #ccc;max-height:160px;overflow:auto}
.suggestBox div{padding:8px;border-bottom:1px solid #eee}
.suggestBox div:hover{background:#e0f0ff}

/* ===== PRINT ===== */
#printArea{display:none}
@media print{
 body *{display:none}
 #printArea{
  display:block;
  position:fixed;
  inset:0;
  background:#fff;
 }
 #printArea *{display:block}
}
</style>
</head>
<body>

<h2>üì¶ KHO NHANH</h2>

<input id="t" placeholder="T√™n h√†ng">
<div id="goiYHang" class="suggestBox"></div>
<select id="list"><option value="">-- Ch·ªçn nhanh h√†ng --</option></select>

<input id="s" type="number" placeholder="S·ªë l∆∞·ª£ng">

<input id="dv" placeholder="ƒê∆°n v·ªã">
<div id="goiYDV" class="suggestBox"></div>

<input id="kh" placeholder="Kh√°ch h√†ng">
<div id="goiYKH" class="suggestBox"></div>
<select id="listKH"><option value="">-- Ch·ªçn nhanh KH --</option></select>

<button class="n" onclick="nhap()">‚ûï NH·∫¨P</button>
<button class="x" onclick="xuat()">‚ûñ XU·∫§T</button>
<button class="print" onclick="inPDF()">üñ®Ô∏è IN PHI·∫æU</button>
<button class="del" onclick="xoa()">üóëÔ∏è XO√Å H√ÄNG</button>
<button class="ex" onclick="xuatExcel()">‚¨áÔ∏è EXCEL</button>

<h3>üîé Ki·ªÉm tra nhanh t·ªìn kho</h3>
<input id="checkHang" placeholder="G√µ t√™n h√†ng">
<div id="ketQuaTon" class="suggestBox"></div>

<table>
<tr><th>H√†ng</th><th>T·ªìn</th><th>ƒêV</th><th>·∫¢nh</th><th>·∫¢nh</th></tr>
<tbody id="b"></tbody>
</table>

<input type="file" id="imgInput" accept="image/*" hidden>

<h3>üìä T·ªîNG XU·∫§T THEO KH</h3>
<table>
<tr><th>Kh√°ch h√†ng</th><th>T·ªïng SL</th></tr>
<tbody id="tongkh"></tbody>
</table>

<button class="warn" onclick="xoaLichSu()">‚ö†Ô∏è XO√Å TO√ÄN B·ªò L·ªäCH S·ª¨</button>
<button class="ex" onclick="saoLuu()">üíæ SAO L∆ØU</button>
<input type="file" id="fileRestore" accept=".json">

<h3>üïí L·ªäCH S·ª¨</h3>
<table>
<tr><th>Th·ªùi gian</th><th>H√†ng</th><th>KH</th><th>Lo·∫°i</th><th>SL</th></tr>
<tbody id="ls"></tbody>
</table>

<!-- ===== PRINT ===== -->
<div id="printArea">
 <h3>PHI·∫æU XU·∫§T KHO</h3>
 <p>Th·ªùi gian: <span id="pTime"></span></p>
 <p>Kh√°ch h√†ng: <span id="pKH"></span></p>
 <table>
  <tr><th>H√†ng</th><th>SL</th><th>ƒêV</th></tr>
  <tbody id="pBody"></tbody>
 </table>
 <br>
 <p>Ng∆∞·ªùi giao _____________  Ng∆∞·ªùi nh·∫≠n _____________</p>
</div>

<script>
let k=JSON.parse(localStorage.getItem("k")||"{}");
let h=JSON.parse(localStorage.getItem("h")||"[]");
let khs=JSON.parse(localStorage.getItem("khs")||"[]");
let dvs=JSON.parse(localStorage.getItem("dvs")||"[]");
let hangDangSuaAnh="";

/* ===== G·ª¢I √ù ===== */
list.onchange=()=>{t.value=list.value;if(k[list.value])dv.value=k[list.value].dv||""};
listKH.onchange=()=>kh.value=listKH.value;

t.oninput=()=>goiYHang.innerHTML=Object.keys(k)
.filter(i=>i.toLowerCase().includes(t.value.toLowerCase()))
.map(i=>`<div onclick="t.value='${i}';dv.value='${k[i].dv||""}';goiYHang.innerHTML=''">${i}</div>`).join("");

kh.oninput=()=>goiYKH.innerHTML=khs
.filter(i=>i.toLowerCase().includes(kh.value.toLowerCase()))
.map(i=>`<div onclick="kh.value='${i}';goiYKH.innerHTML=''">${i}</div>`).join("");

dv.oninput=()=>goiYDV.innerHTML=dvs
.filter(i=>i.toLowerCase().includes(dv.value.toLowerCase()))
.map(i=>`<div onclick="dv.value='${i}';goiYDV.innerHTML=''">${i}</div>`).join("");

checkHang.oninput=()=>ketQuaTon.innerHTML=Object.keys(k)
.filter(i=>i.toLowerCase().includes(checkHang.value.toLowerCase()))
.map(i=>`<div>${i}: ${k[i].sl} ${k[i].dv}${k[i].img?`<br><img src="${k[i].img}" class="thumb">`:""}</div>`).join("");

/* ===== NH·∫¨P ===== */
function nhap(){
 if(!t.value||s.value<=0)return alert("Thi·∫øu d·ªØ li·ªáu");
 if(!k[t.value])k[t.value]={sl:0,dv:dv.value,img:""};
 k[t.value].sl+=+s.value;k[t.value].dv=dv.value;
 if(kh.value&&!khs.includes(kh.value))khs.push(kh.value);
 if(dv.value&&!dvs.includes(dv.value))dvs.push(dv.value);
 h.unshift({time:new Date().toISOString(),ten:t.value,kh:kh.value,loai:"Nh·∫≠p",sl:+s.value,dv:dv.value});
 t.value=s.value=dv.value=kh.value="";
 save();
}

/* ===== XU·∫§T ===== */
function xuat(){
 if(!kh.value)return alert("Ch∆∞a nh·∫≠p kh√°ch h√†ng");
 if(!k[t.value]||k[t.value].sl<+s.value)return alert("Kh√¥ng ƒë·ªß t·ªìn");
 k[t.value].sl-=+s.value;
 h.unshift({time:new Date().toISOString(),ten:t.value,kh:kh.value,loai:"Xu·∫•t",sl:+s.value,dv:k[t.value].dv});
 t.value=s.value=kh.value="";
 save();
}

/* ===== XO√Å ===== */
function xoa(){
 if(!t.value||!k[t.value])return alert("Kh√¥ng t√¨m th·∫•y");
 if(k[t.value].sl>0)return alert("C√≤n t·ªìn, kh√¥ng th·ªÉ xo√°");
 if(confirm("Xo√° h√†ng n√†y?")){delete k[t.value];save();}
}
function xoaLichSu(){if(confirm("Xo√° to√†n b·ªô l·ªãch s·ª≠?")){h=[];save();}}

/* ===== ·∫¢NH IPHONE ===== */
function suaAnh(ten){
 hangDangSuaAnh=ten;imgInput.value="";imgInput.click();
}
imgInput.onchange=e=>{
 let f=e.target.files[0];if(!f)return;
 let q=f.size>1024*1024?0.65:0.85;
 let r=new FileReader();
 r.onload=ev=>{
  let img=new Image();
  img.onload=()=>{
   let dpr=window.devicePixelRatio||2;
   let size=70,real=size*dpr;
   let s=Math.min(img.width,img.height);
   let c=document.createElement("canvas");
   c.width=c.height=real;
   let ctx=c.getContext("2d");
   ctx.setTransform(1,0,0,1,0,0);
   ctx.scale(dpr,dpr);
   ctx.imageSmoothingQuality="high";
   ctx.drawImage(img,(img.width-s)/2,(img.height-s)/2,s,s,0,0,size,size);
   k[hangDangSuaAnh].img=c.toDataURL("image/jpeg",q);
   save();
  };
  img.src=ev.target.result;
 };
 r.readAsDataURL(f);
};

/* ===== IN PDF ===== */
function inPDF(){
 let ds=h.filter(i=>i.loai=="Xu·∫•t");
 if(!ds.length)return alert("Ch∆∞a c√≥ xu·∫•t kho");
 let time=ds[0].time;
 let same=ds.filter(i=>i.time===time);
 pTime.textContent=new Date(time).toLocaleString("vi-VN");
 pKH.textContent=same[0].kh;
 pBody.innerHTML=same.map(i=>`<tr><td>${i.ten}</td><td>${i.sl}</td><td>${i.dv}</td></tr>`).join("");
 window.print();
}

/* ===== EXCEL ===== */
function xuatExcel(){
 const wb=XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb,
  XLSX.utils.aoa_to_sheet([["H√†ng","T·ªìn","ƒêV"],...Object.keys(k).map(i=>[i,k[i].sl,k[i].dv])]),
  "TonKho");
 XLSX.utils.book_append_sheet(wb,
  XLSX.utils.aoa_to_sheet([["Th·ªùi gian","H√†ng","KH","Lo·∫°i","SL","ƒêV"],
   ...h.map(i=>[
    new Date(i.time).toLocaleString("vi-VN",{hour12:false}),
    i.ten,i.kh,i.loai,i.sl,i.dv
   ])
  ]),"LichSu");
 XLSX.writeFile(wb,"kho_nhanh.xlsx");
}

/* ===== SAO L∆ØU ===== */
function saoLuu(){
 const data=JSON.stringify({k,h,khs,dvs});
 const a=document.createElement("a");
 a.href=URL.createObjectURL(new Blob([data]));
 a.download="kho_nhanh_backup.json";
 a.click();
}
fileRestore.onchange=e=>{
 let r=new FileReader();
 r.onload=()=>{let d=JSON.parse(r.result);k=d.k||{};h=d.h||[];khs=d.khs||[];dvs=d.dvs||[];save();}
 r.readAsText(e.target.files[0]);
};

/* ===== RENDER ===== */
function save(){
 localStorage.setItem("k",JSON.stringify(k));
 localStorage.setItem("h",JSON.stringify(h));
 localStorage.setItem("khs",JSON.stringify(khs));
 localStorage.setItem("dvs",JSON.stringify(dvs));
 render();
}
function render(){
 list.innerHTML='<option value="">-- Ch·ªçn nhanh h√†ng --</option>';
 listKH.innerHTML='<option value="">-- Ch·ªçn nhanh KH --</option>';
 b.innerHTML="";
 Object.keys(k).forEach(i=>{
  list.innerHTML+=`<option>${i}</option>`;
  b.innerHTML+=`<tr class="${k[i].sl<=5?'low':''}">
   <td>${i}</td><td>${k[i].sl}</td><td>${k[i].dv}</td>
   <td>${k[i].img?`<img src="${k[i].img}" class="thumb">`:""}</td>
   <td><button class="edit" onclick="suaAnh('${i}')">üñº</button></td>
  </tr>`;
 });
 khs.forEach(i=>listKH.innerHTML+=`<option>${i}</option>`);
 let tong={};
 h.forEach(i=>i.loai=="Xu·∫•t"&&i.kh&&(tong[i.kh]=(tong[i.kh]||0)+i.sl));
 tongkh.innerHTML=Object.keys(tong).map(i=>`<tr><td>${i}</td><td>${tong[i]}</td></tr>`).join("");
 ls.innerHTML=h.map(i=>`
 <tr>
  <td>${new Date(i.time).toLocaleString("vi-VN",{hour12:false})}</td>
  <td>${i.ten}</td><td>${i.kh}</td><td>${i.loai}</td><td>${i.sl}</td>
 </tr>`).join("");
}
render();
</script>
</body>
</html>
