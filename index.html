<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<title>ğŸ“¦ KHO NHANH</title>

<style>
body{font-family:-apple-system,Arial;background:#f2f2f2;padding:10px}
h2,h3{text-align:center}
input,button,select{width:100%;font-size:22px;padding:12px;margin:6px 0}
button{border:none;border-radius:8px;color:#fff}
.n{background:#28a745}.x{background:#dc3545}
.ex{background:#17a2b8}.del{background:#6c757d}
.warn{background:#ff9800}.print{background:#343a40}
.edit{background:#ffc107;color:#000}
table{width:100%;background:#fff;border-collapse:collapse;margin-top:10px}
td,th{border:1px solid #ccc;padding:8px;font-size:16px;text-align:center}
.low{background:#ffd6d6}
.thumb{width:70px;height:70px;object-fit:cover;border-radius:6px}

/* ===== PHIáº¾U ===== */
#phieuBox{
 position:fixed;inset:0;background:rgba(0,0,0,.5);
 display:none;align-items:center;justify-content:center;z-index:999
}
#phieu{
 background:#fff;width:800px;max-width:95%;padding:15px
}
#phieu table{width:100%;border-collapse:collapse}
#phieu td,#phieu th{border:1px solid #333;padding:6px}
@media print{
 body *{visibility:hidden}
 #phieuBox,#phieuBox *{visibility:visible}
 #phieuBox{position:static;background:none}
}
</style>
</head>

<body>

<h2>ğŸ“¦ KHO NHANH</h2>

<input id="t" placeholder="TÃªn hÃ ng">
<input id="s" type="number" placeholder="Sá»‘ lÆ°á»£ng">
<input id="dv" placeholder="ÄÆ¡n vá»‹">
<input id="kh" placeholder="KhÃ¡ch hÃ ng">

<button class="n" onclick="nhap()">â• NHáº¬P</button>
<button class="x" onclick="xuat()">â– XUáº¤T</button>
<button class="ex" onclick="moPhieu()">ğŸ§¾ PHIáº¾U XUáº¤T</button>
<button class="ex" onclick="xuatExcel()">â¬‡ï¸ EXCEL</button>

<table>
<tr><th>HÃ ng</th><th>Tá»“n</th><th>ÄV</th><th>áº¢nh</th></tr>
<tbody id="b"></tbody>
</table>

<input type="file" id="imgInput" accept="image/*" hidden>

<!-- ===== PHIáº¾U XUáº¤T ===== -->
<div id="phieuBox">
 <div id="phieu">
  <div style="display:flex;gap:10px;align-items:center">
   <img src="logo.png" style="height:60px">
   <div>
    <b>TÃŠN Cá»¬A HÃ€NG</b><br>
    ğŸ“ 0123 456 789
   </div>
  </div>

  <h3>PHIáº¾U XUáº¤T KHO</h3>
  Sá»‘ phiáº¿u: <b id="soPhieu"></b><br>
  NgÃ y: <b id="ngayPhieu"></b><br>
  KhÃ¡ch hÃ ng: <b id="khPhieu"></b>

  <table>
   <thead>
    <tr><th>STT</th><th>HÃ ng</th><th>SL</th><th>ÄV</th></tr>
   </thead>
   <tbody id="dsPhieu"></tbody>
   <tfoot>
    <tr><th colspan="2">Tá»”NG</th><th id="tongSL">0</th><th></th></tr>
   </tfoot>
  </table>

  <button class="n" onclick="chotPhieu()">âœ… CHá»T</button>
  <button class="warn" onclick="huyPhieu()">â†© HUá»¶</button>
  <button class="ex" onclick="inPDF()">ğŸ–¨ PDF</button>
  <button class="del" onclick="dongPhieu()">âŒ ÄÃ“NG</button>
 </div>
</div>

<script>
/* ===== DATA ===== */
let k=JSON.parse(localStorage.getItem("k")||"{}");
let h=JSON.parse(localStorage.getItem("h")||"[]");

let phieuDangLap=[];
let phieuDaChot=[];

/* ===== KHO ===== */
function nhap(){
 if(!t.value||s.value<=0)return;
 if(!k[t.value])k[t.value]={sl:0,dv:dv.value,img:""};
 k[t.value].sl+=+s.value;k[t.value].dv=dv.value;
 h.unshift({time:new Date().toLocaleString("vi-VN"),ten:t.value,loai:"Nháº­p",sl:+s.value});
 save();
}
function xuat(){
 if(!k[t.value]||k[t.value].sl<+s.value)return alert("KhÃ´ng Ä‘á»§ tá»“n");
 k[t.value].sl-=+s.value;
 phieuDangLap.push({ten:t.value,sl:+s.value,dv:k[t.value].dv});
 save();
}

/* ===== PHIáº¾U ===== */
function moPhieu(){
 if(!phieuDangLap.length)return alert("ChÆ°a cÃ³ hÃ ng");
 soPhieu.innerText="PX-"+Date.now();
 ngayPhieu.innerText=new Date().toLocaleDateString("vi-VN");
 khPhieu.innerText=kh.value;
 capNhatPhieu();
 phieuBox.style.display="flex";
}
function dongPhieu(){phieuBox.style.display="none"}

function capNhatPhieu(){
 let tong=0;
 dsPhieu.innerHTML=phieuDangLap.map((i,idx)=>{
  tong+=i.sl;
  return `<tr><td>${idx+1}</td><td>${i.ten}</td><td>${i.sl}</td><td>${i.dv}</td></tr>`;
 }).join("");
 tongSL.innerText=tong;
}

function chotPhieu(){
 phieuDaChot.push(JSON.parse(JSON.stringify(phieuDangLap)));
 phieuDangLap=[];
 alert("âœ… ÄÃ£ chá»‘t phiáº¿u");
 dongPhieu();
}

function huyPhieu(){
 if(!confirm("Huá»· & hoÃ n kho?"))return;
 phieuDangLap.forEach(i=>k[i.ten].sl+=i.sl);
 phieuDangLap=[];
 save();
 dongPhieu();
}

function inPDF(){
 html2pdf().set({
  filename:`phieu_xuat_${ngayPhieu.innerText.replaceAll('/','-')}.pdf`,
  html2canvas:{scale:2},
  jsPDF:{format:'a4'}
 }).from(phieu).save();
}

/* ===== EXCEL ===== */
function xuatExcel(){
 const wb=XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb,
  XLSX.utils.aoa_to_sheet([["HÃ ng","Tá»“n","ÄV"],...Object.keys(k).map(i=>[i,k[i].sl,k[i].dv])]),
  "TonKho");
 XLSX.writeFile(wb,`kho_${new Date().toLocaleDateString("vi-VN").replaceAll('/','-')}.xlsx`);
}

/* ===== SAVE / RENDER ===== */
function save(){
 localStorage.setItem("k",JSON.stringify(k));
 localStorage.setItem("h",JSON.stringify(h));
 render();
}
function render(){
 b.innerHTML=Object.keys(k).map(i=>`
 <tr>
  <td>${i}</td><td>${k[i].sl}</td><td>${k[i].dv}</td>
  <td>${k[i].img?`<img src="${k[i].img}" class="thumb">`:""}</td>
 </tr>`).join("");
}
render();
</script>

</body>
</html>
