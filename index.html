<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<title>ğŸ“¦ KHO NHANH</title>

<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#28a745">

<style>
body{font-family:-apple-system,Arial;background:#f2f2f2;padding:10px}
h2,h3{text-align:center}
input,button,select{width:100%;font-size:22px;padding:12px;margin:6px 0}
button{border:none;border-radius:8px;color:#fff}
.n{background:#28a745}.x{background:#dc3545}
.ex{background:#17a2b8}.del{background:#6c757d}
.warn{background:#ff9800}.edit{background:#ffc107;color:#000}
table{width:100%;background:#fff;border-collapse:collapse;margin-top:10px}
td,th{border:1px solid #ccc;padding:8px;font-size:16px;text-align:center}
.low{background:#ffd6d6}
.suggestBox{background:#fff;border:1px solid #ccc;max-height:160px;overflow:auto}
.suggestBox div{padding:8px;border-bottom:1px solid #eee}
.suggestBox div:hover{background:#e0f0ff}
.thumb{width:70px;height:70px;object-fit:cover;border-radius:6px}

/* ===== PHIáº¾U ===== */
#phieuBox{
 position:fixed;inset:0;background:rgba(0,0,0,.5);
 display:none;align-items:center;justify-content:center;z-index:9999
}
#phieu{
 background:#fff;width:820px;max-width:96%;
 padding:15px;border-radius:8px
}
#phieu h3{text-align:center;margin:8px 0}
#phieu table{width:100%;border-collapse:collapse}
#phieu th,#phieu td{border:1px solid #333;padding:6px;text-align:center}
#phieu .head{display:flex;gap:10px;align-items:center}
#phieu img{height:60px}
@media print{
 body *{visibility:hidden}
 #phieuBox,#phieuBox *{visibility:visible}
 #phieuBox{position:static;background:none}
}
</style>
</head>

<body>

<h2>ğŸ“¦ KHO NHANH</h2>

<input id="t" placeholder="Nháº­p tÃªn hÃ ng">
<div id="goiYHang" class="suggestBox"></div>
<select id="list"><option value="">-- Chá»n nhanh hÃ ng --</option></select>

<input id="s" type="number" placeholder="Sá»‘ lÆ°á»£ng">
<input id="dv" placeholder="ÄÆ¡n vá»‹">
<div id="goiYDV" class="suggestBox"></div>

<input id="kh" placeholder="TÃªn khÃ¡ch hÃ ng">
<div id="goiYKH" class="suggestBox"></div>
<select id="listKH"><option value="">-- Chá»n nhanh KH --</option></select>

<button class="n" onclick="nhap()">â• NHáº¬P</button>
<button class="x" onclick="xuat()">â– XUáº¤T</button>
<button class="del" onclick="xoa()">ğŸ—‘ï¸ XOÃ HÃ€NG</button>
<button class="ex" onclick="xuatExcel()">â¬‡ï¸ XUáº¤T EXCEL</button>
<button class="ex" onclick="moPhieu()">ğŸ§¾ PHIáº¾U XUáº¤T</button>

<h3>ğŸ” Kiá»ƒm tra nhanh tá»“n kho</h3>
<input id="checkHang" placeholder="GÃµ tÃªn hÃ ng">
<div id="ketQuaTon" class="suggestBox"></div>

<table>
<tr>
<th>HÃ ng</th><th>Tá»“n</th><th>ÄÆ¡n vá»‹</th><th>áº¢nh</th><th>Sá»­a áº£nh</th>
</tr>
<tbody id="b"></tbody>
</table>

<input type="file" id="imgInput" accept="image/*" style="display:none">

<h3>ğŸ“Š Tá»”NG XUáº¤T THEO KH</h3>
<table>
<tr><th>KhÃ¡ch hÃ ng</th><th>Tá»•ng SL</th></tr>
<tbody id="tongkh"></tbody>
</table>

<button class="warn" onclick="xoaLichSu()">âš ï¸ XOÃ TOÃ€N Bá»˜ Lá»ŠCH Sá»¬</button>
<button class="ex" onclick="saoLuu()">ğŸ’¾ SAO LÆ¯U</button>
<input type="file" id="fileRestore" accept=".json">

<h3>ğŸ•’ Lá»ŠCH Sá»¬</h3>
<table>
<tr>
<th>Thá»i gian</th><th>HÃ ng</th><th>KH</th><th>Loáº¡i</th><th>SL</th><th>ÄV</th>
</tr>
<tbody id="ls"></tbody>
</table>

<!-- ===== PHIáº¾U XUáº¤T ===== -->
<div id="phieuBox">
 <div id="phieu">
  <div class="head">
   <img src="logo.png">
   <div>
    <b>TÃŠN Cá»¬A HÃ€NG</b><br>
    ğŸ“ 0123 456 789
   </div>
  </div>

  <h3>PHIáº¾U XUáº¤T KHO</h3>
  Sá»‘ phiáº¿u: <b id="px_so"></b><br>
  NgÃ y: <b id="px_ngay"></b><br>
  KhÃ¡ch hÃ ng: <b id="px_kh"></b>

  <table>
   <thead>
    <tr><th>STT</th><th>HÃ ng</th><th>SL</th><th>ÄÆ¡n vá»‹</th></tr>
   </thead>
   <tbody id="px_ds"></tbody>
   <tfoot>
    <tr><th colspan="2">Tá»”NG</th><th id="px_tong">0</th><th></th></tr>
   </tfoot>
  </table>

  <br>
  <button class="n" onclick="chotPhieu()">âœ… CHá»T PHIáº¾U</button>
  <button class="warn" onclick="huyPhieu()">â†© HUá»¶ PHIáº¾U</button>
  <button class="ex" onclick="inPDF()">ğŸ–¨ IN / PDF</button>
  <button class="del" onclick="dongPhieu()">âŒ ÄÃ“NG</button>
 </div>
</div>

<script>
/* ===== DATA ===== */
let k=JSON.parse(localStorage.getItem("k")||"{}");
let h=JSON.parse(localStorage.getItem("h")||"[]");
let khs=JSON.parse(localStorage.getItem("khs")||"[]");
let dvs=JSON.parse(localStorage.getItem("dvs")||"[]");
let hangDangSuaAnh="";
let phieuDangLap=[];
let phieuDaChot=JSON.parse(localStorage.getItem("phieuDaChot")||"[]");

/* ===== Gá»¢I Ã ===== */
list.onchange=()=>{t.value=list.value;if(k[list.value])dv.value=k[list.value].dv||""};
listKH.onchange=()=>kh.value=listKH.value;

t.oninput=()=>goiYHang.innerHTML=Object.keys(k)
.filter(i=>i.toLowerCase().includes(t.value.toLowerCase()))
.map(i=>`<div onclick="t.value='${i}';dv.value='${k[i].dv||""}';goiYHang.innerHTML=''">${i}</div>`).join("");

kh.oninput=()=>goiYKH.innerHTML=khs
.filter(i=>i.toLowerCase().includes(kh.value.toLowerCase()))
.map(i=>`<div onclick="kh.value='${i}';goiYKH.innerHTML=''">${i}</div>`).join("");

dv.oninput=()=>goiYDV.innerHTML=dvs
.filter(i=>i.toLowerCase().includes(dv.value.toLowerCase()))
.map(i=>`<div onclick="dv.value='${i}';goiYDV.innerHTML=''">${i}</div>`).join("");

checkHang.oninput=()=>ketQuaTon.innerHTML=Object.keys(k)
.filter(i=>i.toLowerCase().includes(checkHang.value.toLowerCase()))
.map(i=>`<div>${i}: ${k[i].sl} ${k[i].dv}${k[i].img?`<br><img src="${k[i].img}" class="thumb">`:""}</div>`).join("");

function save(){
 localStorage.setItem("k",JSON.stringify(k));
 localStorage.setItem("h",JSON.stringify(h));
 localStorage.setItem("khs",JSON.stringify(khs));
 localStorage.setItem("dvs",JSON.stringify(dvs));
 render();
}

function nhap(){
 if(!t.value||s.value<=0)return alert("Thiáº¿u dá»¯ liá»‡u");
 if(!k[t.value])k[t.value]={sl:0,dv:dv.value,img:""};
 k[t.value].sl+=+s.value;k[t.value].dv=dv.value;
 if(kh.value&&!khs.includes(kh.value))khs.push(kh.value);
 if(dv.value&&!dvs.includes(dv.value))dvs.push(dv.value);
 h.unshift({time:new Date().toLocaleString(),ten:t.value,kh:kh.value,loai:"Nháº­p",sl:+s.value,dv:dv.value});
 t.value=s.value=dv.value=kh.value="";
 save();
}

const xuatCu=xuat;
function xuat(){
 if(!k[t.value]||k[t.value].sl<+s.value)return alert("KhÃ´ng Ä‘á»§ tá»“n");
 phieuDangLap.push({ten:t.value,sl:+s.value,dv:k[t.value].dv});
 k[t.value].sl-=+s.value;
 h.unshift({time:new Date().toLocaleString(),ten:t.value,kh:kh.value,loai:"Xuáº¥t",sl:+s.value,dv:k[t.value].dv});
 t.value=s.value=kh.value="";
 save();capNhatPhieu();
}

/* ===== PHIáº¾U ===== */
function moPhieu(){
 if(!kh.value)return alert("ChÆ°a chá»n KH");
 phieuDangLap=[];
 px_so.innerText="PX-"+Date.now();
 px_ngay.innerText=new Date().toLocaleDateString("vi-VN");
 px_kh.innerText=kh.value;
 capNhatPhieu();
 phieuBox.style.display="flex";
}
function dongPhieu(){phieuBox.style.display="none"}
function capNhatPhieu(){
 let tong=0;
 px_ds.innerHTML=phieuDangLap.map((i,idx)=>{
  tong+=i.sl;
  return `<tr><td>${idx+1}</td><td>${i.ten}</td><td>${i.sl}</td><td>${i.dv}</td></tr>`;
 }).join("");
 px_tong.innerText=tong;
}
function chotPhieu(){
 if(!phieuDangLap.length)return alert("Phiáº¿u trá»‘ng");
 phieuDaChot.push({so:px_so.innerText,ngay:px_ngay.innerText,kh:px_kh.innerText,ds:[...phieuDangLap]});
 localStorage.setItem("phieuDaChot",JSON.stringify(phieuDaChot));
 alert("âœ… ÄÃ£ chá»‘t");
}
function huyPhieu(){
 if(!confirm("Huá»· phiáº¿u?"))return;
 let p=phieuDaChot.pop();
 if(p){p.ds.forEach(i=>k[i.ten].sl+=i.sl);save();}
 localStorage.setItem("phieuDaChot",JSON.stringify(phieuDaChot));
 alert("â†© ÄÃ£ hoÃ n kho");
}
function inPDF(){
 html2pdf().set({
  filename:`phieu_xuat_${px_ngay.innerText.replaceAll('/','-')}.pdf`,
  margin:5,html2canvas:{scale:2},jsPDF:{format:'a4'}
 }).from(document.getElementById("phieu")).save();
}

function render(){
 list.innerHTML='<option value="">-- Chá»n nhanh hÃ ng --</option>';
 listKH.innerHTML='<option value="">-- Chá»n nhanh KH --</option>';
 b.innerHTML="";
 for(let i in k){
  list.innerHTML+=`<option>${i}</option>`;
  b.innerHTML+=`<tr class="${k[i].sl<5?'low':''}">
   <td>${i}</td><td>${k[i].sl}</td><td>${k[i].dv}</td>
   <td>${k[i].img?`<img src="${k[i].img}" class="thumb">`:""}</td>
   <td><button class="edit" onclick="suaAnh('${i}')">ğŸ–¼</button></td>
  </tr>`;
 }
 khs.forEach(i=>listKH.innerHTML+=`<option>${i}</option>`);
 let tong={};
 h.forEach(i=>i.loai=="Xuáº¥t"&&i.kh&&(tong[i.kh]=(tong[i.kh]||0)+i.sl));
 tongkh.innerHTML=Object.keys(tong).map(i=>`<tr><td>${i}</td><td>${tong[i]}</td></tr>`).join("");
 ls.innerHTML=h.map(i=>`<tr><td>${i.time}</td><td>${i.ten}</td><td>${i.kh}</td><td>${i.loai}</td><td>${i.sl}</td><td>${i.dv}</td></tr>`).join("");
}
render();
</script>
</body>
</html>
