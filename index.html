<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<title>Kho Nhanh</title>

<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#28a745">

<style>
body{font-family:Arial;background:#f2f2f2;padding:10px}
h2,h3{text-align:center}
input,button,select{width:100%;font-size:22px;padding:12px;margin:6px 0}
button{border:none;border-radius:8px;color:#fff}
.n{background:#28a745}.x{background:#dc3545}
.ex{background:#17a2b8}.del{background:#6c757d}
.warn{background:#ff9800}
table{width:100%;background:#fff;border-collapse:collapse;margin-top:10px}
td,th{border:1px solid #ccc;padding:8px;font-size:17px;text-align:center}
.low{background:#ffd6d6}
.suggestBox{background:#fff;border:1px solid #ccc;max-height:180px;overflow:auto}
.suggestBox div{padding:8px;border-bottom:1px solid #eee}
.suggestBox div:hover{background:#e0f0ff}
</style>
</head>

<body>
<h2>üì¶ KHO NHANH</h2>

<input id="t" placeholder="Nh·∫≠p t√™n h√†ng">
<div id="goiYHang" class="suggestBox"></div>

<input id="dv" placeholder="ƒê∆°n v·ªã (kg, th√πng, c√°i...)">

<select id="list"><option value="">-- Ch·ªçn nhanh h√†ng --</option></select>

<input id="kh" placeholder="T√™n kh√°ch h√†ng">
<div id="goiYKH" class="suggestBox"></div>

<select id="listKH"><option value="">-- Ch·ªçn nhanh KH --</option></select>

<input id="s" type="number" placeholder="S·ªë l∆∞·ª£ng">

<button class="n" onclick="nhap()">‚ûï NH·∫¨P</button>
<button class="x" onclick="xuat()">‚ûñ XU·∫§T</button>
<button class="del" onclick="xoa()">üóëÔ∏è XO√Å H√ÄNG</button>
<button class="ex" onclick="xuatExcel()">‚¨áÔ∏è XU·∫§T EXCEL</button>

<h3>üîé Ki·ªÉm tra nhanh t·ªìn kho</h3>
<input id="checkHang" placeholder="G√µ t√™n h√†ng (t√¨m ch·ª©a ch·ªØ)">
<div id="ketQuaTon" class="suggestBox"></div>

<table>
<tr><th>H√†ng</th><th>T·ªìn</th></tr>
<tbody id="b"></tbody>
</table>

<h3>üìä T·ªîNG XU·∫§T THEO KH</h3>
<table>
<tr><th>Kh√°ch h√†ng</th><th>T·ªïng SL</th></tr>
<tbody id="tongkh"></tbody>
</table>

<button class="ex" onclick="saoLuu()">üíæ SAO L∆ØU</button>
<input type="file" id="fileRestore" style="display:none" accept=".json">
<button class="warn" onclick="fileRestore.click()">‚ôªÔ∏è KH√îI PH·ª§C</button>
<button class="warn" onclick="xoaLichSu()">‚ö†Ô∏è XO√Å L·ªäCH S·ª¨</button>

<h3>üïí L·ªãch s·ª≠</h3>
<table>
<tr><th>Th·ªùi gian</th><th>H√†ng</th><th>ƒê∆°n v·ªã</th><th>KH</th><th>Lo·∫°i</th><th>SL</th></tr>
<tbody id="ls"></tbody>
</table>

<script>
let rawK = JSON.parse(localStorage.getItem("k")||"{}");
let k = {};
for(let i in rawK){
 if(typeof rawK[i]==="number") k[i]={sl:rawK[i],dv:""};
 else k[i]=rawK[i];
}
let h = JSON.parse(localStorage.getItem("h")||"[]");
let khs = JSON.parse(localStorage.getItem("khs")||"[]");

list.onchange=()=>t.value=list.value;
listKH.onchange=()=>kh.value=listKH.value;

/* G·ª¢I √ù H√ÄNG + ƒê∆†N V·ªä */
t.oninput=function(){
 let q=this.value.toLowerCase(), html="";
 if(!q){goiYHang.innerHTML="";return;}
 for(let i in k){
  if(i.toLowerCase().includes(q)){
   html+=`<div onclick="chonHang('${i}')">üì¶ ${i} ${k[i].dv?`(${k[i].dv})`:""}</div>`;
  }
 }
 goiYHang.innerHTML=html;
}
function chonHang(v){
 t.value=v; dv.value=k[v].dv||""; goiYHang.innerHTML="";
}

/* G·ª¢I √ù KH */
kh.oninput=function(){
 let q=this.value.toLowerCase(), html="";
 if(!q){goiYKH.innerHTML="";return;}
 khs.forEach(i=>{
  if(i.toLowerCase().includes(q))
   html+=`<div onclick="kh.value='${i}';goiYKH.innerHTML=''">${i}</div>`;
 });
 goiYKH.innerHTML=html;
}

/* T√åM T·ªíN */
checkHang.oninput=function(){
 let q=this.value.toLowerCase(), html="";
 if(!q){ketQuaTon.innerHTML="";return;}
 for(let i in k)
  if(i.toLowerCase().includes(q))
   html+=`<div>üì¶ ${i} : ${k[i].sl} ${k[i].dv||""}</div>`;
 ketQuaTon.innerHTML=html||"Kh√¥ng c√≥";
}

function save(){
 localStorage.setItem("k",JSON.stringify(k));
 localStorage.setItem("h",JSON.stringify(h));
 localStorage.setItem("khs",JSON.stringify(khs));
 render();
}

function nhap(){
 let ten=t.value.trim(), sl=+s.value, donvi=dv.value.trim(), khach=kh.value.trim();
 if(!ten||sl<=0) return alert("Nh·∫≠p thi·∫øu");
 if(!k[ten]) k[ten]={sl:0,dv:donvi};
 k[ten].sl+=sl; if(donvi) k[ten].dv=donvi;
 if(khach&&!khs.includes(khach)) khs.push(khach);
 h.unshift({time:new Date().toLocaleString(),ten,dv:donvi,kh:khach,loai:"Nh·∫≠p",sl});
 t.value=s.value=dv.value=kh.value="";
 save();
}

function xuat(){
 let ten=t.value.trim(), sl=+s.value, khach=kh.value.trim();
 if(!ten||sl<=0||!khach) return alert("Xu·∫•t c·∫ßn KH");
 if(!k[ten]||k[ten].sl<sl) return alert("Kh√¥ng ƒë·ªß t·ªìn");
 k[ten].sl-=sl;
 if(!khs.includes(khach)) khs.push(khach);
 h.unshift({time:new Date().toLocaleString(),ten,dv:k[ten].dv,kh:khach,loai:"Xu·∫•t",sl});
 t.value=s.value=dv.value=kh.value="";
 save();
}

function xoa(){let ten=t.value.trim();if(ten&&confirm("Xo√° "+ten+" ?")){delete k[ten];save();}}
function xoaLichSu(){if(confirm("Xo√° to√†n b·ªô l·ªãch s·ª≠?")){h=[];save();}}

function render(){
 list.innerHTML='<option value="">-- Ch·ªçn nhanh h√†ng --</option>';
 listKH.innerHTML='<option value="">-- Ch·ªçn nhanh KH --</option>';
 b.innerHTML="";
 for(let i in k){
  list.innerHTML+=`<option>${i}</option>`;
  b.innerHTML+=`<tr class="${k[i].sl<5?'low':''}"><td>${i}</td><td>${k[i].sl} ${k[i].dv||""}</td></tr>`;
 }
 khs.forEach(i=>listKH.innerHTML+=`<option>${i}</option>`);
 let tong={};
 h.forEach(i=>{if(i.loai==="Xu·∫•t"&&i.kh) tong[i.kh]=(tong[i.kh]||0)+i.sl});
 tongkh.innerHTML="";
 for(let i in tong) tongkh.innerHTML+=`<tr><td>${i}</td><td>${tong[i]}</td></tr>`;
 ls.innerHTML="";
 h.slice(0,100).forEach(i=>{
  ls.innerHTML+=`<tr><td>${i.time}</td><td>${i.ten}</td><td>${i.dv||""}</td><td>${i.kh}</td><td>${i.loai}</td><td>${i.sl}</td></tr>`;
 });
}

function xuatExcel(){
 let wb=XLSX.utils.book_new();
 let ton=[["H√†ng","T·ªìn","ƒê∆°n v·ªã"]];
 for(let i in k) ton.push([i,k[i].sl,k[i].dv||""]);
 XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(ton),"TON_KHO");

 let lsx=[["Th·ªùi gian","H√†ng","ƒê∆°n v·ªã","KH","Lo·∫°i","SL"]];
 h.forEach(i=>lsx.push([i.time,i.ten,i.dv||"",i.kh||"",i.loai,i.sl]));
 XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(lsx),"LICH_SU");

 let tong={}; h.forEach(i=>{if(i.loai==="Xu·∫•t"&&i.kh) tong[i.kh]=(tong[i.kh]||0)+i.sl});
 let tkh=[["Kh√°ch h√†ng","T·ªïng SL"]];
 for(let i in tong) tkh.push([i,tong[i]]);
 XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(tkh),"TONG_KH");

 XLSX.writeFile(wb,"kho-nhanh.xlsx");
}

function saoLuu(){
 let blob=new Blob([JSON.stringify({k,h,khs},null,2)],{type:"application/json"});
 let name="kho-backup-"+new Date().toISOString().slice(0,10)+".json";
 let a=document.createElement("a");
 a.href=URL.createObjectURL(blob);
 a.download=name;
 a.click();
 alert("‚úÖ Sao l∆∞u th√†nh c√¥ng!");
}

fileRestore.onchange=e=>{
 let r=new FileReader();
 r.onload=()=>{let d=JSON.parse(r.result);k=d.k||{};h=d.h||[];khs=d.khs||[];save();}
 r.readAsText(e.target.files[0]);
}

render();
</script>
</body>
</html>
