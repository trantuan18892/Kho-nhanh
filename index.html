<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<title>ğŸ“¦ KHO NHANH</title>

<style>
body{font-family:-apple-system,Arial;background:#f2f2f2;padding:10px}
h2,h3{text-align:center}
input,button,select{width:100%;font-size:22px;padding:12px;margin:6px 0}
button{border:none;border-radius:8px;color:#fff}
.n{background:#28a745}.x{background:#dc3545}
.ex{background:#17a2b8}.del{background:#6c757d}
.warn{background:#ff9800}.print{background:#343a40}
.edit{background:#ffc107;color:#000}
table{width:100%;background:#fff;border-collapse:collapse;margin-top:10px}
td,th{border:1px solid #ccc;padding:8px;font-size:16px;text-align:center}
.low{background:#ffd6d6}
.suggestBox{background:#fff;border:1px solid #ccc;max-height:160px;overflow:auto}
.suggestBox div{padding:8px;border-bottom:1px solid #eee}
.suggestBox div:hover{background:#e0f0ff}
.thumb{width:70px;height:70px;object-fit:cover;border-radius:6px}
.phieuBox{background:#fff;padding:10px;border-radius:8px;margin-top:10px}
</style>
</head>

<body>

<h2>ğŸ“¦ KHO NHANH</h2>

<!-- ===== NHáº¬P XUáº¤T Láºº (GIá»® NGUYÃŠN CODE Gá»C) ===== -->
<input id="t" placeholder="Nháº­p tÃªn hÃ ng">
<div id="goiYHang" class="suggestBox"></div>
<select id="list"><option value="">-- Chá»n nhanh hÃ ng --</option></select>

<input id="s" type="number" placeholder="Sá»‘ lÆ°á»£ng">
<input id="dv" placeholder="ÄÆ¡n vá»‹">
<div id="goiYDV" class="suggestBox"></div>

<input id="kh" placeholder="TÃªn khÃ¡ch hÃ ng">
<div id="goiYKH" class="suggestBox"></div>
<select id="listKH"><option value="">-- Chá»n nhanh KH --</option></select>

<button class="n" onclick="nhap()">â• NHáº¬P</button>
<button class="x" onclick="xuat()">â– XUáº¤T</button>
<button class="del" onclick="xoa()">ğŸ—‘ï¸ XOÃ HÃ€NG</button>
<button class="ex" onclick="xuatExcel()">â¬‡ï¸ XUáº¤T EXCEL</button>

<h3>ğŸ” Kiá»ƒm tra nhanh tá»“n kho</h3>
<input id="checkHang" placeholder="GÃµ tÃªn hÃ ng">
<div id="ketQuaTon" class="suggestBox"></div>

<table>
<tr>
<th>HÃ ng</th><th>Tá»“n</th><th>ÄÆ¡n vá»‹</th><th>áº¢nh</th><th>Sá»­a áº£nh</th>
</tr>
<tbody id="b"></tbody>
</table>

<input type="file" id="imgInput" accept="image/*" style="display:none">

<h3>ğŸ“Š Tá»”NG XUáº¤T THEO KH</h3>
<table>
<tr><th>KhÃ¡ch hÃ ng</th><th>Tá»•ng SL</th></tr>
<tbody id="tongkh"></tbody>
</table>

<button class="warn" onclick="xoaLichSu()">âš ï¸ XOÃ TOÃ€N Bá»˜ Lá»ŠCH Sá»¬</button>
<button class="ex" onclick="saoLuu()">ğŸ’¾ SAO LÆ¯U</button>
<input type="file" id="fileRestore" accept=".json">

<h3>ğŸ•’ Lá»ŠCH Sá»¬</h3>
<table>
<tr>
<th>Thá»i gian</th><th>HÃ ng</th><th>KH</th><th>Loáº¡i</th><th>SL</th><th>ÄV</th>
</tr>
<tbody id="ls"></tbody>
</table>

<!-- ===== MODULE PHIáº¾U XUáº¤T (KHá»I Táº O) ===== -->
<h3>ğŸ“„ PHIáº¾U XUáº¤T KHO</h3>

<div class="phieuBox">
 <input id="px_kh" placeholder="KhÃ¡ch hÃ ng">
 <button class="n" onclick="themDongPhieu()">â• ThÃªm hÃ ng</button>

 <table>
  <tr><th>HÃ ng</th><th>SL</th><th>ÄV</th><th>X</th></tr>
  <tbody id="px_body"></tbody>
 </table>

 <h3>Tá»•ng SL: <span id="px_tong">0</span></h3>

 <button class="print" onclick="chotPhieu()">ğŸ”’ CHá»T PHIáº¾U</button>
 <button class="warn" onclick="huyPhieu()">â™»ï¸ HUá»¶ PHIáº¾U</button>
</div>

<script>
/* ===== DATA Gá»C ===== */
let k=JSON.parse(localStorage.getItem("k")||"{}");
let h=JSON.parse(localStorage.getItem("h")||"[]");
let khs=JSON.parse(localStorage.getItem("khs")||"[]");
let dvs=JSON.parse(localStorage.getItem("dvs")||"[]");

/* ===== PHIáº¾U XUáº¤T DATA ===== */
let phieu={
 id:null,
 kh:"",
 items:[],
 trangThai:"tam"
};

/* ===== HÃ€M PHIáº¾U (PHáº¦N LOGIC HOÃ€N CHá»ˆNH á» PHáº¦N 2) ===== */
function themDongPhieu(){
 phieu.items.push({ten:"",sl:0,dv:""});
 renderPhieu();
}
function renderPhieu(){
 let tong=0;
 px_body.innerHTML=phieu.items.map((i,idx)=>{
  tong+=Number(i.sl||0);
  return `<tr>
   <td><input value="${i.ten}" onchange="phieu.items[${idx}].ten=this.value"></td>
   <td><input type="number" value="${i.sl}" onchange="phieu.items[${idx}].sl=this.value;renderPhieu()"></td>
   <td><input value="${i.dv}" onchange="phieu.items[${idx}].dv=this.value"></td>
   <td><button onclick="phieu.items.splice(${idx},1);renderPhieu()">âŒ</button></td>
  </tr>`;
 }).join("");
 px_tong.textContent=tong;
}
<!-- ===== PHIáº¾U XUáº¤T ===== -->
<style>
#phieuBox{
 position:fixed;inset:0;background:rgba(0,0,0,.5);
 display:none;align-items:center;justify-content:center;z-index:999
}
#phieu{
 background:#fff;width:800px;max-width:95%;padding:15px
}
#phieu h3{text-align:center;margin:5px 0}
#phieu table{width:100%;border-collapse:collapse}
#phieu td,#phieu th{border:1px solid #333;padding:6px;text-align:center}
@media print{
 body *{visibility:hidden}
 #phieuBox,#phieuBox *{visibility:visible}
 #phieuBox{position:static;background:none}
}
</style>

<button class="ex" onclick="moPhieu()">ğŸ§¾ PHIáº¾U XUáº¤T</button>

<div id="phieuBox">
 <div id="phieu">
  <div style="display:flex;align-items:center;gap:10px">
   <img id="logoCT" src="logo.png" style="height:60px">
   <div>
    <b id="tenCT">TÃŠN Cá»¬A HÃ€NG</b><br>
    ğŸ“ <span id="sdtCT">0123 456 789</span>
   </div>
  </div>

  <h3>PHIáº¾U XUáº¤T KHO</h3>
  <div>
   Sá»‘ phiáº¿u: <b id="soPhieu"></b><br>
   NgÃ y: <b id="ngayPhieu"></b><br>
   KhÃ¡ch hÃ ng: <b id="khPhieu"></b>
  </div>

  <table>
   <thead>
    <tr>
     <th>STT</th><th>HÃ ng</th><th>SL</th><th>ÄÆ¡n vá»‹</th>
    </tr>
   </thead>
   <tbody id="dsPhieu"></tbody>
   <tfoot>
    <tr>
     <th colspan="2">Tá»”NG</th>
     <th id="tongSL">0</th>
     <th></th>
    </tr>
   </tfoot>
  </table>

  <br>
  <button class="n" onclick="chotPhieu()">âœ… CHá»T PHIáº¾U</button>
  <button class="warn" onclick="huyPhieu()">â†© HUá»¶ PHIáº¾U</button>
  <button class="ex" onclick="inPDF()">ğŸ–¨ IN / PDF</button>
  <button class="del" onclick="dongPhieu()">âŒ ÄÃ“NG</button>
 </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
let phieuDangLap=[];
let phieuDaChot=[];

function moPhieu(){
 if(!kh.value) return alert("ChÆ°a chá»n khÃ¡ch hÃ ng");
 phieuDangLap=[];
 capNhatPhieu();
 soPhieu.innerText="PX-"+Date.now();
 ngayPhieu.innerText=new Date().toLocaleDateString("vi-VN");
 khPhieu.innerText=kh.value;
 phieuBox.style.display="flex";
}

function dongPhieu(){phieuBox.style.display="none"}

function themVaoPhieu(){
 if(!k[t.value]||s.value<=0) return;
 phieuDangLap.push({
  ten:t.value,
  sl:+s.value,
  dv:k[t.value].dv
 });
 capNhatPhieu();
}

function capNhatPhieu(){
 let tong=0;
 dsPhieu.innerHTML=phieuDangLap.map((i,idx)=>{
  tong+=i.sl;
  return `<tr>
   <td>${idx+1}</td>
   <td>${i.ten}</td>
   <td>${i.sl}</td>
   <td>${i.dv}</td>
  </tr>`;
 }).join("");
 tongSL.innerText=tong;
}

const oldXuat = xuat;
xuat = function(){
 oldXuat();
 themVaoPhieu();
};

function chotPhieu(){
 if(!phieuDangLap.length) return alert("Phiáº¿u trá»‘ng");
 phieuDaChot.push({
  so:soPhieu.innerText,
  ngay:ngayPhieu.innerText,
  kh:khPhieu.innerText,
  ds:JSON.parse(JSON.stringify(phieuDangLap))
 });
 alert("âœ… ÄÃ£ chá»‘t phiáº¿u");
}

function huyPhieu(){
 if(!confirm("Huá»· phiáº¿u Ä‘Ã£ chá»‘t?")) return;
 let p=phieuDaChot.pop();
 if(p){
  p.ds.forEach(i=>{
   k[i.ten].sl+=i.sl;
  });
  save();
 }
 alert("â†© ÄÃ£ huá»·");
}

function inPDF(){
 html2pdf().set({
  filename:`phieu_xuat_${ngayPhieu.innerText.replaceAll('/','-')}.pdf`,
  margin:5,
  image:{type:'jpeg',quality:0.98},
  html2canvas:{scale:2},
  jsPDF:{unit:'mm',format:'a4'}
 }).from(document.getElementById("phieu")).save();
}
</script>
</script>
