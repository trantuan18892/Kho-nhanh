<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>üì¶ KHO NHANH</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body{font-family:-apple-system,Arial;background:#f2f2f2;padding:10px}
h2,h3{text-align:center}
input,button,select{width:100%;font-size:20px;padding:12px;margin:6px 0}
button{border:none;border-radius:8px;color:#fff}
.n{background:#28a745}.x{background:#dc3545}
.ex{background:#17a2b8}.del{background:#6c757d}
.warn{background:#ff9800}.print{background:#343a40}
.edit{background:#ffc107;color:#000}
table{width:100%;background:#fff;border-collapse:collapse;margin-top:10px}
td,th{border:1px solid #ccc;padding:6px;font-size:16px;text-align:center}
.low{background:#ffd6d6}
.thumb{width:70px;height:70px;object-fit:cover;border-radius:8px}

/* ===== IN PDF ===== */
@media print{
 body *{display:none}
 #printArea,#printArea *{display:block}
 body{margin:0}
}
#printArea{
 font-family:-apple-system,Arial;
 padding:20px;
}
.print-header{text-align:center}
.print-header h2{margin:0}
.print-info{display:flex;justify-content:space-between;margin:10px 0}
.print-table{width:100%;border-collapse:collapse}
.print-table th,.print-table td{border:1px solid #000;padding:8px}
.print-sign{display:flex;justify-content:space-between;margin-top:40px}
.print-sign div{text-align:center;width:45%}
</style>
</head>
<body>

<h2>üì¶ KHO NHANH</h2>

<input id="t" placeholder="T√™n h√†ng">
<input id="s" type="number" placeholder="S·ªë l∆∞·ª£ng">
<input id="dv" placeholder="ƒê∆°n v·ªã">
<input id="kh" placeholder="Kh√°ch h√†ng">

<button class="n" onclick="nhap()">‚ûï NH·∫¨P</button>
<button class="x" onclick="xuat()">‚ûñ XU·∫§T</button>
<button class="print" onclick="inPDF()">üñ®Ô∏è IN PHI·∫æU</button>
<button class="del" onclick="xoa()">üóëÔ∏è XO√Å H√ÄNG</button>
<button class="ex" onclick="xuatExcel()">‚¨áÔ∏è EXCEL</button>
<button class="warn" onclick="saoLuu()">üíæ BACKUP</button>

<table>
<tr><th>H√†ng</th><th>T·ªìn</th><th>ƒêV</th><th>·∫¢nh</th><th>·∫¢nh</th></tr>
<tbody id="b"></tbody>
</table>

<input type="file" id="imgInput" accept="image/*" hidden>

<h3>üïí L·ªäCH S·ª¨</h3>
<table>
<tr><th>Th·ªùi gian</th><th>H√†ng</th><th>KH</th><th>Lo·∫°i</th><th>SL</th></tr>
<tbody id="ls"></tbody>
</table>

<!-- ===== PHI·∫æU IN ===== -->
<div id="printArea">
 <div class="print-header">
  <h2>PHI·∫æU XU·∫§T KHO</h2>
  <p>Ng√†y: <span id="pTime"></span></p>
 </div>

 <div class="print-info">
  <div><b>Kh√°ch h√†ng:</b> <span id="pKH"></span></div>
  <div><b>S·ªë phi·∫øu:</b> PX-<span id="pSo"></span></div>
 </div>

 <table class="print-table">
  <tr><th>STT</th><th>H√†ng</th><th>SL</th><th>ƒêV</th></tr>
  <tbody id="pBody"></tbody>
 </table>

 <div class="print-sign">
  <div><p><b>Ng∆∞·ªùi giao</b></p><p>K√Ω t√™n</p></div>
  <div><p><b>Ng∆∞·ªùi nh·∫≠n</b></p><p>K√Ω t√™n</p></div>
 </div>
</div>

<script>
/* ===== DATA ===== */
let k=JSON.parse(localStorage.getItem("k")||"{}");
let h=JSON.parse(localStorage.getItem("h")||"[]");
let hangDangSuaAnh="";

/* ===== NG√ÄY VN ===== */
function ngayVN(){
 const d=new Date();
 return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0");
}

/* ===== NH·∫¨P ===== */
function nhap(){
 if(!t.value||s.value<=0)return alert("Thi·∫øu d·ªØ li·ªáu");
 if(!k[t.value])k[t.value]={sl:0,dv:dv.value,img:""};
 k[t.value].sl+=+s.value;
 k[t.value].dv=dv.value;
 h.unshift({time:new Date().toISOString(),ten:t.value,kh:kh.value,loai:"Nh·∫≠p",sl:+s.value});
 t.value=s.value=dv.value=kh.value="";
 save();
}

/* ===== XU·∫§T ===== */
function xuat(){
 if(!kh.value)return alert("Ch∆∞a nh·∫≠p kh√°ch h√†ng");
 if(!k[t.value]||k[t.value].sl<+s.value)return alert("Kh√¥ng ƒë·ªß t·ªìn");
 k[t.value].sl-=+s.value;
 h.unshift({time:new Date().toISOString(),ten:t.value,kh:kh.value,loai:"Xu·∫•t",sl:+s.value});
 save();
}

/* ===== XO√Å ===== */
function xoa(){
 if(!t.value||!k[t.value])return alert("Kh√¥ng t√¨m th·∫•y");
 if(k[t.value].sl>0)return alert("C√≤n t·ªìn");
 if(confirm("Xo√° h√†ng n√†y?")){delete k[t.value];save();}
}

/* ===== ·∫¢NH ‚Äì R√ï IPHONE ===== */
function suaAnh(ten){
 hangDangSuaAnh=ten;
 imgInput.value="";
 imgInput.click();
}
imgInput.onchange=e=>{
 let f=e.target.files[0]; if(!f)return;
 let q=f.size>1024*1024?0.65:0.85;
 let r=new FileReader();
 r.onload=ev=>{
  let img=new Image();
  img.onload=()=>{
   let dpr=window.devicePixelRatio||3;
   let size=70,real=size*dpr;
   let s=Math.min(img.width,img.height);
   let c=document.createElement("canvas");
   c.width=c.height=real;
   let ctx=c.getContext("2d");
   ctx.setTransform(dpr,0,0,dpr,0,0);
   ctx.imageSmoothingQuality="high";
   ctx.drawImage(img,(img.width-s)/2,(img.height-s)/2,s,s,0,0,size,size);
   k[hangDangSuaAnh].img=c.toDataURL("image/jpeg",q);
   save();
  };
  img.src=ev.target.result;
 };
 r.readAsDataURL(f);
};

/* ===== IN ===== */
function inPDF(){
 let ds=h.filter(i=>i.loai=="Xu·∫•t");
 if(!ds.length)return alert("Ch∆∞a c√≥ xu·∫•t");
 let last=ds[0];
 pTime.textContent=new Date(last.time).toLocaleString("vi-VN");
 pKH.textContent=last.kh;
 pSo.textContent=Date.now().toString().slice(-6);
 pBody.innerHTML=`<tr><td>1</td><td>${last.ten}</td><td>${last.sl}</td><td>${k[last.ten].dv}</td></tr>`;
 window.print();
}

/* ===== EXCEL ===== */
function xuatExcel(){
 const wb=XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb,
  XLSX.utils.aoa_to_sheet([["H√†ng","T·ªìn","ƒêV"],...Object.keys(k).map(i=>[i,k[i].sl,k[i].dv])]),
  "TonKho");
 XLSX.utils.book_append_sheet(wb,
  XLSX.utils.aoa_to_sheet([["Th·ªùi gian","H√†ng","KH","Lo·∫°i","SL"],...h.map(i=>[
   new Date(i.time).toLocaleString("vi-VN"),i.ten,i.kh,i.loai,i.sl
  ])]),
  "LichSu");
 XLSX.writeFile(wb,`kho_nhanh_${ngayVN()}.xlsx`);
}

/* ===== BACKUP ===== */
function saoLuu(){
 const data=JSON.stringify({k,h},null,2);
 const a=document.createElement("a");
 a.href=URL.createObjectURL(new Blob([data],{type:"application/json"}));
 a.download=`kho_nhanh_backup_${ngayVN()}.json`;
 a.click();
}

/* ===== SAVE / RENDER ===== */
function save(){
 localStorage.setItem("k",JSON.stringify(k));
 localStorage.setItem("h",JSON.stringify(h));
 render();
}
function render(){
 b.innerHTML="";
 Object.keys(k).forEach(i=>{
  b.innerHTML+=`<tr class="${k[i].sl<=5?'low':''}">
   <td>${i}</td><td>${k[i].sl}</td><td>${k[i].dv}</td>
   <td>${k[i].img?`<img src="${k[i].img}" class="thumb">`:""}</td>
   <td><button class="edit" onclick="suaAnh('${i}')">üñº</button></td>
  </tr>`;
 });
 ls.innerHTML=h.map(i=>`
 <tr>
  <td>${new Date(i.time).toLocaleString("vi-VN",{hour12:false})}</td>
  <td>${i.ten}</td><td>${i.kh||""}</td><td>${i.loai}</td><td>${i.sl}</td>
 </tr>`).join("");
}
render();
</script>
</body>
</html>
